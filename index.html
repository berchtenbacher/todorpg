<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lofi RPG Todo</title>

    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="assets/icon-192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#030712">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Jacquard+24&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <script src="game_data.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }

        /* --- Day / Night Theme Variables --- */
        :root {
            --bg-image: url('assets/background1.png');
            --overlay-opacity: 0.2;
            --ui-bg-opacity: 0.5;
        }

        body.theme-night {
            --bg-image: url('assets/background2.png');
            --overlay-opacity: 0.7;
            --ui-bg-opacity: 0.3;
        }

        #bg-layer-image {
            background-image: var(--bg-image);
            transition: background-image 0.5s ease-in-out;
        }

        #bg-layer-overlay {
            background-color: rgba(0, 0, 0, var(--overlay-opacity));
            transition: background-color 0.5s ease-in-out;
        }

        /* --- Animations --- */
        @keyframes float { 0% { transform: translate(-50%, 0); opacity: 1; } 100% { transform: translate(-50%, -100px); opacity: 0; } }
        .animate-float { animation: float 1s ease-out forwards; }

        @keyframes radiantPulse {
            0% { box-shadow: 0 0 20px rgba(234, 179, 8, 0.3); border-color: rgba(234, 179, 8, 0.6); }
            50% { box-shadow: 0 0 50px rgba(234, 179, 8, 0.8), 0 0 10px rgba(255, 255, 255, 0.5); border-color: rgba(255, 215, 0, 1); }
            100% { box-shadow: 0 0 20px rgba(234, 179, 8, 0.3); border-color: rgba(234, 179, 8, 0.6); }
        }
        .animate-radiant { animation: radiantPulse 2s infinite ease-in-out; }

        @keyframes twinkle {
            0%, 100% { opacity: 0.3; transform: scale(0.8); }
            50% { opacity: 1; transform: scale(1.2) rotate(45deg); }
        }
        .animate-twinkle { animation: twinkle 1.5s infinite ease-in-out; }

        @keyframes itemPop { 
            0% { transform: scale(0) rotate(-15deg); opacity: 0; } 
            50% { transform: scale(1.2) rotate(5deg); opacity: 1; } 
            70% { transform: scale(0.9) rotate(-5deg); } 
            100% { transform: scale(1) rotate(0); opacity: 1; } 
        }
        @keyframes itemFadeOut { 0% { opacity: 1; transform: scale(1) translateY(0); } 100% { opacity: 0; transform: scale(1.1) translateY(-20px); } }
        .animate-item-pop { animation: itemPop 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        .animate-item-fade { animation: itemFadeOut 0.5s ease-in forwards; }

        /* Level Up Animations */
        @keyframes cinematicIn { 0% { transform: scaleX(0); opacity: 0; } 100% { transform: scaleX(1); opacity: 1; } }
        @keyframes textZoom { 0% { transform: scale(0.5); opacity: 0; letter-spacing: 0px; } 50% { transform: scale(1.2); opacity: 1; letter-spacing: 10px; } 100% { transform: scale(1); opacity: 1; letter-spacing: 5px; } }
        .level-banner-bg { animation: cinematicIn 0.5s cubic-bezier(0.25, 1, 0.5, 1) forwards; }
        .level-banner-text { animation: textZoom 0.8s cubic-bezier(0.25, 1, 0.5, 1) forwards; }

        /* Scrollbars & Utilities */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.4); }

        .round-checkbox {
            appearance: none; width: 1.5em; height: 1.5em; /* Slightly larger for mobile */
            border: 2px solid rgba(255,255,255,0.3); border-radius: 50%;
            display: grid; place-content: center; cursor: pointer; transition: 0.2s;
            flex-shrink: 0;
        }
        .round-checkbox::before {
            content: ""; width: 0.85em; height: 0.85em; border-radius: 50%;
            transform: scale(0); transition: 120ms transform ease-in-out;
            background-color: white; box-shadow: inset 1em 1em white;
        }
        .round-checkbox:checked { background-color: #a855f7; border-color: #a855f7; }
        .round-checkbox:checked::before { transform: scale(1); }
    </style>
</head>
<body class="bg-gray-950 text-white overflow-x-hidden min-h-screen relative selection:bg-yellow-500/30">

    <div id="bg-layer-image" class="fixed inset-0 bg-cover bg-center pointer-events-none" style="filter: brightness(1.0);"></div>
    <div id="bg-layer-overlay" class="fixed inset-0 pointer-events-none"></div>
    <div id="effects-container" class="fixed inset-0 pointer-events-none z-[60]"></div>

    <div id="side-menu" class="fixed top-0 left-0 h-full w-full sm:w-96 backdrop-blur-xl bg-gray-900/95 sm:bg-gray-900/40 border-r border-white/10 shadow-2xl transform -translate-x-full transition-transform duration-300 z-50 overflow-y-auto custom-scrollbar">
        <div class="p-6 sm:p-8 pb-24"> <button id="close-menu-btn" class="float-right text-white/60 hover:text-white mb-6 p-2"><i data-lucide="x"></i></button>
            
            <div class="flex flex-col items-center mb-8 clear-both">
                <div class="w-40 h-40 sm:w-48 sm:h-48 rounded-lg mb-4 overflow-hidden border-2 border-white/10 shadow-lg">
                     <img src="assets/cleric3.gif" alt="Cleric" class="w-full h-full object-cover" style="image-rendering: pixelated;">
                </div>
                
                <h2 class="text-2xl font-bold text-white">Onion Knight</h2>
                
                <div class="relative group mt-2">
                    <select id="character-selector" class="appearance-none bg-black/30 border border-white/10 text-white/80 text-xs py-1 pl-3 pr-8 rounded-full focus:outline-none cursor-pointer hover:border-yellow-500/50 transition-colors">
                        <option value="paladin">Paladin (Lv <span id="opt-lvl-paladin">?</span>)</option>
                        <option value="cleric">Cleric (Lv 1)</option>
                        <option value="rogue">Rogue (Locked)</option>
                    </select>
                    <div class="absolute right-2 top-1/2 transform -translate-y-1/2 pointer-events-none text-white/40">
                        <i data-lucide="chevron-down" class="w-3 h-3"></i>
                    </div>
                </div>

                <button onclick="hardReset()" class="text-[10px] text-red-500/30 hover:text-red-500 mt-4 uppercase tracking-widest transition-colors">Reset Save</button>
            </div>

            <div class="space-y-4 mb-6">
                <div class="bg-gray-800/50 rounded-lg p-4 border border-white/10">
                    <div class="flex items-center justify-between mb-2"><span class="text-white/80 text-lg">Level</span><span id="player-level" class="text-4xl font-bold text-yellow-300">1</span></div>
                </div>
                <div class="bg-gray-800/50 rounded-lg p-4 border border-white/10">
                    <div class="flex items-center justify-between mb-3"><span class="text-white/80 text-lg">XP</span><span id="xp-text" class="text-sm text-white/60">0 / 100</span></div>
                    <div class="w-full bg-gray-700/50 rounded-full h-3 overflow-hidden"><div id="xp-bar" class="bg-gradient-to-r from-blue-500 to-purple-500 h-full rounded-full transition-all duration-500" style="width: 0%"></div></div>
                </div>
            </div>
            
            <div id="sub-stats-grid" class="grid grid-cols-2 gap-3 mb-6"></div>
            
            <div class="bg-gray-800/50 rounded-lg p-4 border border-white/10">
                <h3 class="text-white/90 text-2xl mb-4 text-center w-full" style="font-family: 'Jacquard 24', system-ui;">Inventory</h3>
                <div id="artifacts-list" class="flex flex-wrap justify-center gap-3"></div>
            </div>
        </div>
    </div>

    <div class="relative z-10 min-h-screen flex items-start justify-center p-4 md:p-6 lg:p-8 pt-6 sm:pt-12">
        <div class="w-full max-w-2xl">
            <div class="backdrop-blur-xl bg-gray-900/60 sm:bg-gray-900/40 rounded-3xl border border-white/10 shadow-2xl p-5 sm:p-8 transition-all">
                
                <div class="flex items-center justify-between mb-6">
                    <button onclick="toggleTheme()" id="theme-btn" class="w-10 h-10 flex items-center justify-center rounded-full bg-white/5 border border-white/10 text-white/60 hover:text-yellow-400 hover:bg-white/10 transition-all active:scale-95">
                        <i data-lucide="sun" class="w-5 h-5"></i>
                    </button>

                    <h1 class="text-4xl sm:text-6xl text-white text-center leading-none mt-1" style="font-family: 'Jacquard 24', system-ui;">
                        Undertakings
                    </h1>

                    <button id="open-menu-btn" class="w-10 h-10 flex items-center justify-center rounded-full bg-white/5 border border-white/10 text-white/80 hover:text-white hover:bg-white/10 transition-all active:scale-95">
                        <i data-lucide="menu" class="w-5 h-5"></i>
                    </button>
                </div>

                <div class="flex gap-2 mb-6">
                    <input type="text" id="new-task-input" placeholder="Add a new quest..." class="flex-1 bg-gray-800/50 border border-white/20 rounded-xl px-4 py-3 text-white placeholder-white/40 focus:outline-none focus:border-white/60 transition-all text-sm sm:text-base">
                    <button id="add-task-btn" class="bg-gray-800/50 border border-white/20 hover:bg-gray-700/50 text-white/80 hover:text-white rounded-xl px-4 sm:px-6 py-3 transition-all active:bg-gray-700"><i data-lucide="plus"></i></button>
                </div>

                <div class="relative flex items-center gap-2 mb-4 group">
                    <button onclick="scrollContainer('category-buttons', 'left')" class="hidden sm:group-hover:block absolute left-0 z-10 bg-gray-900/80 border border-white/10 rounded-lg p-1 text-white/70 backdrop-blur-sm"><i data-lucide="chevron-left" class="w-4 h-4"></i></button>
                    
                    <div id="category-buttons" class="flex overflow-x-auto no-scrollbar gap-2 whitespace-nowrap scroll-smooth flex-1 px-1 py-1"></div>
                    
                    <button onclick="scrollContainer('category-buttons', 'right')" class="hidden sm:group-hover:block absolute right-0 z-10 bg-gray-900/80 border border-white/10 rounded-lg p-1 text-white/70 backdrop-blur-sm"><i data-lucide="chevron-right" class="w-4 h-4"></i></button>
                </div>

                <div class="relative flex items-center gap-2 mb-6 group">
                     <button onclick="scrollContainer('quick-tasks', 'left')" class="hidden sm:group-hover:block absolute left-0 z-10 bg-gray-900/80 border border-white/10 rounded-lg p-1 text-white/70 backdrop-blur-sm"><i data-lucide="chevron-left" class="w-4 h-4"></i></button>

                    <div id="quick-tasks" class="flex overflow-x-auto no-scrollbar gap-2 whitespace-nowrap scroll-smooth flex-1 pb-1 px-1"></div>

                    <button onclick="scrollContainer('quick-tasks', 'right')" class="hidden sm:group-hover:block absolute right-0 z-10 bg-gray-900/80 border border-white/10 rounded-lg p-1 text-white/70 backdrop-blur-sm"><i data-lucide="chevron-right" class="w-4 h-4"></i></button>
                </div>

                <div class="flex p-1 bg-gray-900/60 rounded-xl border border-white/10 mb-6">
                    <button onclick="setView('uncommon')" id="view-btn-uncommon" class="flex-1 py-2 text-xs font-bold uppercase tracking-widest rounded-lg transition-all duration-300">Quest</button>
                    <button onclick="setView('common')" id="view-btn-common" class="flex-1 py-2 text-xs font-bold uppercase tracking-widest rounded-lg transition-all duration-300">Task</button>
                </div>

                <div id="task-list" class="space-y-3 max-h-[60vh] overflow-y-auto pr-1 custom-scrollbar pb-10"></div>

                <div class="mt-4 pt-4 border-t border-white/10 flex items-center justify-center text-xs sm:text-sm">
                    <div id="completion-stats" class="text-white/40">0 / 0 quests completed</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 0. AUDIO SYSTEM ---
        const sounds = {
            xp: new Audio('assets/SFX/xp.mp3'),
            levelup: new Audio('assets/SFX/levelup.mp3'),
            item: new Audio('assets/SFX/item.mp3'),
            dragon: new Audio('assets/SFX/dragon.mp3')
        };
        const playSound = (key) => {
            const s = sounds[key];
            if (s) { s.currentTime = 0; s.volume = 0.4; s.play().catch(() => {}); }
        };

        // --- 1. STATE ---
        const STORAGE_KEY = 'lofi_rpg_save_v2'; 
        
        const initialState = {
            tasks: [],
            level: 1,
            xp: 0,
            inventory: [],
            stats: {
                wisdom: { level: 0, xp: 0 }, strength: { level: 0, xp: 0 }, dexterity: { level: 0, xp: 0 },
                endurance: { level: 0, xp: 0 }, magic: { level: 0, xp: 0 }, mind: { level: 0, xp: 0 },
                quartermastery: { level: 0, xp: 0 }, stewardship: { level: 0, xp: 0 }, vitality: { level: 0, xp: 0 }, willpower: { level: 0, xp: 0 }
            },
            lastResetDate: new Date().toDateString()
        };

        const uiState = {
            menuOpen: false,
            selectedCategory: null,
            editingTaskId: null,
            editingText: '',
            activeView: 'common',
            theme: 'day' 
        };

        function loadGame() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) return { ...initialState, ...JSON.parse(saved) };
            } catch (e) { console.error("Save load error", e); }
            return JSON.parse(JSON.stringify(initialState));
        }

        function saveGame() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        }

        function hardReset() {
            if(confirm("Wipe all progress?")) { localStorage.removeItem(STORAGE_KEY); location.reload(); }
        }

        let state = loadGame();

        // --- 2. GAME LOGIC ---
        const getXPForLevel = (lvl) => Math.floor(GAME_DB.config.xpBase * Math.pow(GAME_DB.config.xpMultiplier, lvl));
        const getCategoryById = (id) => GAME_DB.categories.find(c => c.id === id);

        function getStatMultiplier(statKey) {
            let multiplier = 1.0;
            state.inventory.forEach(itemId => {
                const item = GAME_DB.items[itemId];
                if (item && item.bonus && item.bonus.stat === statKey) multiplier += item.bonus.multiplier;
            });
            return multiplier;
        }

        const checkMidnightReset = () => {
            const today = new Date().toDateString();
            if (today !== state.lastResetDate) {
                state.tasks = state.tasks.map(task => task.isDaily ? { ...task, completed: false } : task);
                state.lastResetDate = today;
                renderTasks(); renderStats(); saveGame();
            }
        };

        function checkItemUnlocks(delay = 0) {
            let newUnlocks = false;
            Object.values(GAME_DB.items).forEach(item => {
                if (state.inventory.includes(item.id)) return;
                if (!item.unlock) return;

                let shouldUnlock = false;
                if (item.unlock.type === 'level') {
                    if (state.level >= item.unlock.value) shouldUnlock = true;
                } else if (item.unlock.type === 'stat') {
                    if (state.stats[item.unlock.stat] && state.stats[item.unlock.stat].level >= item.unlock.value) shouldUnlock = true;
                }

                if (shouldUnlock) {
                    state.inventory.push(item.id);
                    newUnlocks = true;
                    setTimeout(() => {
                        playSound('item');
                        showItemNotification(item);
                    }, delay);
                }
            });
            if (newUnlocks) { saveGame(); renderStats(); }
        }

        // --- 3. ACTIONS ---

        const addTask = (text, specificCategories = []) => {
            if (!text.trim()) return;
            const taskCats = specificCategories.length > 0 ? specificCategories : (uiState.selectedCategory ? [uiState.selectedCategory] : []);

            const isCommon = uiState.activeView === 'common';

            const newTask = {
                id: Date.now(),
                text: text,
                completed: false,
                isDaily: isCommon, 
                viewType: uiState.activeView,
                isDragon: false,
                categories: taskCats
            };

            state.tasks.push(newTask);
            document.getElementById('new-task-input').value = '';
            uiState.selectedCategory = null;
            renderCategories(); renderTasks(); saveGame();
        };

        const toggleTask = (id) => {
            const task = state.tasks.find(t => t.id === id);
            if (!task) return;

            if (!task.completed) {
                const dragonMult = task.isDragon ? 5 : 1;
                let delayForItems = 0;

                if (task.isDragon) {
                    playSound('dragon'); 
                    showDragonVictory(); 
                    delayForItems = 4500; 
                } else {
                    playSound('xp');
                    delayForItems = 0; 
                }

                const genMult = getStatMultiplier('xp');
                const baseXP = GAME_DB.config.xpPerTask || 10;
                const xpGain = Math.round(baseXP * genMult * dragonMult); 
                
                showFloatingXP(xpGain);

                const xpNeeded = getXPForLevel(state.level);
                const newXP = state.xp + xpGain;

                if (newXP >= xpNeeded) {
                    state.level++;
                    state.xp = newXP - xpNeeded;
                    
                    showLevelUpEffect();
                    playSound('levelup');
                    
                    if (delayForItems < 3500) {
                        delayForItems = 3500;
                    }
                } else {
                    state.xp = newXP;
                }

                if (task.categories) {
                    task.categories.forEach(catId => {
                        if (state.stats[catId]) {
                            levelUpStat(catId, dragonMult);
                        }
                    });
                }
                
                checkItemUnlocks(delayForItems);
            }

            task.completed = !task.completed;
            renderTasks(); 
            renderStats(); 
            saveGame();
        };

        // --- DRAGON VICTORY SYSTEM ---
        const DRAGON_QUOTES = [
            "Praise the Sun!", "Radiant Victory!", "Divine Favor Earned!",
            "Slayer of Shadows!", "Main Character Energy!", "Quest of the Century!",
            "You Crushed It!", "Fate Restored!", "The Light Prevails!"
        ];

        const showDragonVictory = () => {
            const container = document.getElementById('effects-container');
            const quote = DRAGON_QUOTES[Math.floor(Math.random() * DRAGON_QUOTES.length)];

            const el = document.createElement('div');
            el.className = 'fixed inset-0 flex items-center justify-center z-[80] pointer-events-none';

            el.innerHTML = `
                <div class="animate-item-pop relative">
                    <div class="absolute inset-0 bg-yellow-500/30 blur-3xl rounded-full scale-125 animate-pulse"></div>
                    <div class="relative bg-gray-900 border-4 border-yellow-500 rounded-2xl p-8 flex flex-col items-center gap-5 shadow-2xl animate-radiant min-w-[320px] max-w-md">
                        <div class="absolute -top-3 -right-3 text-yellow-200 animate-twinkle"><i data-lucide="sparkles" class="w-8 h-8 fill-yellow-200"></i></div>
                        <div class="absolute -bottom-3 -left-3 text-yellow-200 animate-twinkle" style="animation-delay: 0.7s;"><i data-lucide="sparkles" class="w-6 h-6 fill-yellow-200"></i></div>
                        <div class="text-yellow-500 text-xs font-normal tracking-[0.4em] uppercase">Dragon Defeated</div>
                        <div class="w-40 h-40 flex items-center justify-center">
                            <img src="praise.png" class="w-full h-full object-cover object-top" alt="Praise"> 
                        </div>
                        <div class="text-center">
                            <div class="text-4xl sm:text-5xl font-normal text-white mb-1 drop-shadow-md leading-tight" style="font-family: 'Jacquard 24', system-ui;">
                                ${quote}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(el);
            if(window.lucide) lucide.createIcons();
            setTimeout(() => {
                const inner = el.firstElementChild;
                inner.classList.remove('animate-item-pop');
                inner.classList.add('animate-item-fade');
                setTimeout(() => el.remove(), 500);
            }, 4000);
        };

        const levelUpStat = (statKey, multiplierBonus = 1) => {
            const stat = state.stats[statKey];
            const itemMult = getStatMultiplier(statKey);
            const baseXP = 10;
            const totalXP = Math.round(baseXP * itemMult * multiplierBonus);

            const newXP = stat.xp + totalXP;
            const xpNeeded = getXPForLevel(stat.level);

            if (newXP >= xpNeeded) {
                stat.level++;
                stat.xp = newXP - xpNeeded;
            } else {
                stat.xp = newXP;
            }
        };

        const toggleDaily = (id) => {
            const task = state.tasks.find(t => t.id === id);
            if(task) { task.isDaily = !task.isDaily; renderTasks(); saveGame(); }
        };

        const deleteTask = (id) => {
            state.tasks = state.tasks.filter(t => t.id !== id);
            renderTasks(); saveGame();
        };
        
        const toggleDragon = (id) => {
            const task = state.tasks.find(t => t.id === id);
            if(task && !task.completed) {
                task.isDragon = !task.isDragon;
                renderTasks(); saveGame();
            }
        };

        // --- 4. VISUALS ---

        window.setView = (view) => {
            uiState.activeView = view;
            renderViewTabs();
            renderTasks();
        };

        window.toggleTheme = () => {
            uiState.theme = uiState.theme === 'day' ? 'night' : 'day';
            applyTheme();
            saveGame();
        };

        const applyTheme = () => {
            const btn = document.getElementById('theme-btn');
            
            if (uiState.theme === 'night') {
                document.body.classList.add('theme-night');
                if(btn) btn.innerHTML = `<i data-lucide="moon" class="w-5 h-5"></i>`;
            } else {
                document.body.classList.remove('theme-night');
                if(btn) btn.innerHTML = `<i data-lucide="sun" class="w-5 h-5"></i>`;
            }
            if(window.lucide) lucide.createIcons();
        };

        const showFloatingXP = (amount) => {
            const container = document.getElementById('effects-container');
            const el = document.createElement('div');
            el.className = 'fixed top-1/2 left-1/2 transform -translate-x-1/2 text-3xl font-bold text-green-400 pointer-events-none z-50 animate-float';
            el.innerText = `+${amount} XP`;
            container.appendChild(el);
            setTimeout(() => el.remove(), 1000);
        };

        const showLevelUpEffect = () => {
            const container = document.getElementById('effects-container');
            const el = document.createElement('div');
            el.className = 'fixed inset-0 flex flex-col items-center justify-center z-[70] pointer-events-none';
            el.innerHTML = `
                <div class="absolute inset-0 bg-black/80 animate-[fadeIn_0.5s_ease-out]"></div>
                <div class="level-banner-bg absolute w-full h-32 bg-gradient-to-r from-transparent via-yellow-900/50 to-transparent border-y border-yellow-500/30"></div>
                <div class="level-banner-text relative flex flex-col items-center z-10">
                    <div class="text-yellow-400 text-sm font-bold tracking-[0.5em] uppercase mb-2 text-shadow-sm">Ascension</div>
                    <div class="text-7xl text-white font-bold drop-shadow-[0_0_15px_rgba(234,179,8,0.8)]" style="font-family: 'Jacquard 24', system-ui;">LEVEL UP</div>
                    <div class="text-yellow-200/60 text-xl mt-2 font-serif italic">You have grown stronger</div>
                </div>
            `;
            container.appendChild(el);
            setTimeout(() => { el.style.transition='opacity 0.5s'; el.style.opacity='0'; setTimeout(()=>el.remove(),500); }, 3000);
        };

        const showItemNotification = (item) => {
            const container = document.getElementById('effects-container');
            const el = document.createElement('div');
            el.className = 'fixed inset-0 flex items-center justify-center z-[60] pointer-events-none px-4';
            el.innerHTML = `
                <div class="animate-item-pop flex flex-col items-center gap-4 w-full">
                    <div class="absolute inset-0 bg-yellow-500/20 blur-3xl rounded-full scale-150 animate-pulse"></div>
                    <div class="relative bg-gray-900 border-2 border-yellow-500/50 p-6 rounded-2xl shadow-2xl flex flex-col items-center gap-3 w-full max-w-sm">
                        <div class="w-32 h-32 bg-gray-800/50 rounded-xl p-4 border border-white/10 shadow-inner">
                            <img src="${item.image}" class="w-full h-full object-contain drop-shadow-lg" style="image-rendering: pixelated;">
                        </div>
                        <div class="text-center">
                            <div class="text-yellow-400 text-xs font-bold tracking-widest uppercase mb-1">Item Unlocked</div>
                            <div class="text-3xl font-bold text-white mb-2" style="font-family: 'Jacquard 24', system-ui;">${item.name}</div>
                            <div class="text-white/70 text-sm italic font-sans leading-relaxed px-2">${item.description}</div>
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(el);
            setTimeout(() => { el.firstElementChild.classList.remove('animate-item-pop'); el.firstElementChild.classList.add('animate-item-fade'); setTimeout(() => el.remove(), 500); }, 5000);
        };

        // --- RENDERERS ---

        window.scrollContainer = (id, direction = 'right') => {
            const c = document.getElementById(id);
            c.scrollLeft += (direction === 'right' ? 200 : -200);
        };

        const renderCategories = () => {
            document.getElementById('category-buttons').innerHTML = GAME_DB.categories.map(cat => `
                <button onclick="selectCategory('${cat.id}')" class="flex-shrink-0 px-3 py-1.5 rounded-lg text-xs border transition-all ${uiState.selectedCategory === cat.id ? cat.color : 'bg-gray-800/40 text-white/40 border-white/10 hover:bg-gray-700/50'}">${cat.label}</button>
            `).join('');
        };

        const renderQuickTasks = () => {
            document.getElementById('quick-tasks').innerHTML = GAME_DB.quickTasks.map((qt, idx) => `
                <button onclick="addQuickTask(${idx})" class="flex-shrink-0 bg-gray-800/40 border border-white/10 hover:bg-gray-700/50 hover:border-white/20 text-white/70 hover:text-white px-4 py-2 rounded-lg text-sm transition-all flex items-center gap-2">
                    ${qt.name} <div class="flex gap-1">${qt.categories.map(cId=>`<span class="text-xs px-1.5 py-0.5 rounded ${getCategoryById(cId).color}">${getCategoryById(cId).letter}</span>`).join('')}</div>
                </button>
            `).join('');
        };

        const renderViewTabs = () => {
            const commonBtn = document.getElementById('view-btn-common');
            const uncommonBtn = document.getElementById('view-btn-uncommon');
            if (uiState.activeView === 'common') {
                commonBtn.className = "flex-1 py-2 text-xs font-bold uppercase tracking-widest rounded-lg bg-gray-700 text-white shadow-inner";
                uncommonBtn.className = "flex-1 py-2 text-xs font-bold uppercase tracking-widest rounded-lg text-white/40 hover:text-white/60";
            } else {
                uncommonBtn.className = "flex-1 py-2 text-xs font-bold uppercase tracking-widest rounded-lg bg-gray-700 text-white shadow-inner";
                commonBtn.className = "flex-1 py-2 text-xs font-bold uppercase tracking-widest rounded-lg text-white/40 hover:text-white/60";
            }
        };

        const renderTasks = () => {
            const container = document.getElementById('task-list');
            const visibleTasks = state.tasks.filter(t => (t.viewType || 'common') === uiState.activeView);
            
            if (visibleTasks.length === 0) {
                container.innerHTML = `<div class="text-center py-12 text-white/40">No ${uiState.activeView} quests active.</div>`;
                return;
            }

            container.innerHTML = visibleTasks.map(task => {
                const dragonClass = task.isDragon ? "border-yellow-500/50 bg-yellow-900/20 shadow-[0_0_15px_rgba(234,179,8,0.2)]" : "bg-gray-800/30 border-white/10";
                const badges = task.categories.map(cId => `<span class="text-[10px] px-1.5 py-0.5 rounded ${getCategoryById(cId).color}">${getCategoryById(cId).letter}</span>`).join('');
                
                return `
                <div class="${dragonClass} border rounded-xl p-3 hover:bg-gray-800/50 transition-all group flex items-center gap-3 min-h-[3.5rem]">
                    
                    <input type="checkbox" ${task.completed ? 'checked' : ''} onclick="toggleTask(${task.id})" class="round-checkbox shrink-0">
                    
                    <span class="flex-1 text-white text-sm sm:text-base truncate ${task.completed ? 'line-through opacity-50' : ''}" title="${task.text}">
                         ${task.isDragon ? '' : ''}${task.text}
                    </span>
                    
                    <div class="flex items-center gap-2 shrink-0">
                        <div class="flex gap-1">${badges}</div>

                        <div class="flex items-center gap-1">
                             ${!task.completed ? `<button onclick="toggleDragon(${task.id})" class="${task.isDragon ? 'text-yellow-400' : 'text-white/20 hover:text-yellow-500'} p-1.5 transition-colors" title="Toggle Dragon Quest"><i data-lucide="flame" class="w-4 h-4"></i></button>` : ''}
                             
                             <button onclick="toggleDaily(${task.id})" class="px-2 py-1 mx-1 rounded text-[10px] uppercase font-bold tracking-wider transition-all ${task.isDaily ? "bg-blue-500/20 text-blue-300 border border-blue-400/50" : "text-white/20 border border-transparent hover:border-white/20"}">D</button>
                             
                             <button onclick="deleteTask(${task.id})" class="text-red-400/50 hover:text-red-400 p-1.5 transition-colors"><i data-lucide="x" class="w-4 h-4"></i></button>
                        </div>
                    </div>
                </div>`;
            }).join('');
            
            document.getElementById('completion-stats').innerText = `${state.tasks.filter(t=>t.completed).length} / ${state.tasks.length} total completed`;
            lucide.createIcons();
        };

        const renderStats = () => {
            const xpNeeded = getXPForLevel(state.level);
            document.getElementById('player-level').innerText = state.level;
            document.getElementById('xp-text').innerText = `${state.xp} / ${xpNeeded}`;
            document.getElementById('xp-bar').style.width = `${(state.xp / xpNeeded) * 100}%`;

            // Update Class Selector Label if needed
            const paladinLvl = document.getElementById('opt-lvl-paladin');
            if(paladinLvl) paladinLvl.innerText = state.level;

            const createStatHTML = (name, statKey) => {
                const statObj = state.stats[statKey];
                const catDef = getCategoryById(statKey);
                const barColorClass = catDef ? catDef.barColor : 'bg-gray-400';
                const reqXP = getXPForLevel(statObj.level);
                const pct = reqXP > 0 ? (statObj.xp / reqXP) * 100 : 0;
                
                return `
                <div class="bg-gray-800/50 rounded-lg p-2 border border-white/10">
                    <div class="flex justify-between items-center mb-1.5">
                        <div class="text-white/60 text-[10px] font-bold uppercase tracking-tight">${name}</div>
                        <div class="font-bold text-[11px] ${catDef ? (catDef.color.match(/text-\S+/) || ['text-white'])[0] : 'text-white'}">Lv ${statObj.level}</div>
                    </div>
                    <div class="w-full bg-gray-700/50 rounded-full h-1 overflow-hidden"><div class="${barColorClass} h-full rounded-full transition-all duration-500" style="width: ${pct}%"></div></div>
                </div>`;
            };

            const allKeys = ['wisdom', 'strength', 'dexterity', 'endurance', 'magic', 'mind', 'quartermastery', 'stewardship', 'vitality', 'willpower'];
            document.getElementById('sub-stats-grid').innerHTML = allKeys.map(k => createStatHTML(getCategoryById(k).label, k)).join('');

            document.getElementById('artifacts-list').innerHTML = state.inventory.map(itemId => {
                const item = GAME_DB.items[itemId];
                if(!item) return '';
                return `
                    <div class="relative group cursor-pointer hover:scale-110 transition-transform">
                        <div class="w-16 h-16 sm:w-20 sm:h-20 bg-gray-900/60 rounded-xl border border-white/10 p-2 flex items-center justify-center shadow-inner">
                            <img src="${item.image}" alt="${item.name}" class="max-w-full max-h-full object-contain" style="image-rendering: pixelated;">
                        </div>
                        <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-3 px-3 py-2 bg-gray-900 border border-white/20 rounded-lg text-xs text-white/90 z-50 hidden group-hover:block shadow-2xl w-48 whitespace-normal">
                            <div class="font-bold mb-1 text-purple-300">${item.name}</div>
                            <div class="text-white/60 leading-tight">${item.description}</div>
                        </div>
                    </div>`;
            }).join('');
        };

        // --- EVENTS ---
        window.selectCategory = (id) => { uiState.selectedCategory = (uiState.selectedCategory === id) ? null : id; renderCategories(); };
        window.addQuickTask = (index) => { const qt = GAME_DB.quickTasks[index]; addTask(qt.name, qt.categories); };

        document.getElementById('add-task-btn').addEventListener('click', () => addTask(document.getElementById('new-task-input').value));
        document.getElementById('new-task-input').addEventListener('keypress', (e) => { if (e.key === 'Enter') addTask(e.target.value); });
        
        const sideMenu = document.getElementById('side-menu');
        document.getElementById('open-menu-btn').addEventListener('click', () => { sideMenu.classList.remove('-translate-x-full'); sideMenu.classList.add('translate-x-0'); renderStats(); });
        document.getElementById('close-menu-btn').addEventListener('click', () => { sideMenu.classList.add('-translate-x-full'); sideMenu.classList.remove('translate-x-0'); });
        
        // Init
        applyTheme(); // Load theme
        renderCategories(); renderQuickTasks(); renderViewTabs(); renderTasks(); checkMidnightReset(); lucide.createIcons(); checkItemUnlocks();

    </script>
</body>
</html>
